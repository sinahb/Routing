<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ø²Ø§Ø¯ÛŒâ€ŒÙ†Ø§Ùˆ</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { font-family: Tahoma, Arial, sans-serif; }
        body { margin: 0; padding: 10px; background: #f5f5f5; }
        h1 { text-align: center; color: #e74c3c; font-size: 1.4em; margin-bottom: 10px; }
        #map { height: 65vh; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #controls {
            text-align: center;
            margin-top: 10px;
        }
        #start-btn, #nav-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        #nav-btn { background: #3498db; display: none; }
        #status {
            margin-top: 8px;
            font-size: 0.95em;
            color: #555;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ğŸ§­ Ø¢Ø²Ø§Ø¯ÛŒâ€ŒÙ†Ø§Ùˆ</h1>
    <div id="map"></div>
    <div id="controls">
        <button id="start-btn">Ø´Ø±ÙˆØ¹ â€” Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù† Ø±Ø§ Ø¨Ú¯ÛŒØ±</button>
        <br>
        <button id="nav-btn">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø²Ù†Ø¯Ù‡</button>
    </div>
    <div id="status">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯.</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù†Ù‚Ø·Ù‡ Ø±ÙˆÛŒ Ø®Ø· -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>
    <script>
        const AZADI = [35.6972, 51.3378];
        let map = L.map('map').setView([35.6892, 51.3890], 12);
        let userMarker = null;
        let fullRouteGeoJSON = null; // Ù…Ø³ÛŒØ± Ú©Ø§Ù…Ù„ Ø§Ø² OSRM
        let traversedLayer = null;   // Ø¨Ø®Ø´ Ø·ÛŒâ€ŒØ´Ø¯Ù‡
        let remainingLayer = null;   // Ø¨Ø®Ø´ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
        let isNavigating = false;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        L.marker(AZADI, {
            icon: L.divIcon({
                className: '',
                html: '<div style="background:#e74c3c;color:white;font-weight:bold;text-align:center;border-radius:50%;width:32px;height:32px;line-height:32px;font-size:16px;">Ø¢</div>',
                iconSize: [32, 32]
            })
        }).addTo(map).bindPopup('<b>Ø¨Ø±Ø¬ Ø¢Ø²Ø§Ø¯ÛŒ</b>');

        // ØªÙ‚Ø³ÛŒÙ… Ù…Ø³ÛŒØ± Ø¨Ù‡ Ø¯Ùˆ Ø¨Ø®Ø´
        function splitRouteAtNearestPoint(userLatLng) {
            if (!fullRouteGeoJSON) return;

            const line = fullRouteGeoJSON.geometry.coordinates.map(coord => L.latLng(coord[1], coord[0]));
            const nearest = L.GeometryUtil.closest(map, line, userLatLng);
            const nearestIndex = line.findIndex(p => p.equals(nearest));

            if (nearestIndex === -1) return;

            // Ø¨Ø®Ø´ Ø·ÛŒâ€ŒØ´Ø¯Ù‡: Ø§Ø² Ø§Ø¨ØªØ¯Ø§ ØªØ§ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù†Ù‚Ø·Ù‡
            const traversedCoords = line.slice(0, nearestIndex + 1).map(p => [p.lng, p.lat]);
            // Ø¨Ø®Ø´ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: Ø§Ø² Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù†Ù‚Ø·Ù‡ ØªØ§ Ø§Ù†ØªÙ‡Ø§
            const remainingCoords = line.slice(nearestIndex).map(p => [p.lng, p.lat]);

            // Ø­Ø°Ù Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
            if (traversedLayer) map.removeLayer(traversedLayer);
            if (remainingLayer) map.removeLayer(remainingLayer);

            // Ø±Ø³Ù… Ø¨Ø®Ø´ Ø·ÛŒâ€ŒØ´Ø¯Ù‡ (Ø®Ø§Ú©Ø³ØªØ±ÛŒ)
            if (traversedCoords.length > 1) {
                traversedLayer = L.polyline(traversedCoords, {
                    color: '#95a5a6',
                    weight: 6,
                    opacity: 0.7
                }).addTo(map);
            }

            // Ø±Ø³Ù… Ø¨Ø®Ø´ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ø¢Ø¨ÛŒ)
            if (remainingCoords.length > 1) {
                remainingLayer = L.polyline(remainingCoords, {
                    color: '#3498db',
                    weight: 6,
                    opacity: 0.9
                }).addTo(map);
            }
        }

        async function fetchRoute(start, end) {
            const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes?.length > 0) {
                    fullRouteGeoJSON = data.routes[0].geometry;
                    // Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø±: Ú©Ù„ Ù…Ø³ÛŒØ± Ø¢Ø¨ÛŒ
                    if (remainingLayer) map.removeLayer(remainingLayer);
                    remainingLayer = L.geoJSON(fullRouteGeoJSON, {
                        style: { color: '#3498db', weight: 6, opacity: 0.9 }
                    }).addTo(map);
                    document.getElementById('nav-btn').style.display = 'inline-block';
                    document.getElementById('status').innerText = "Ù…Ø³ÛŒØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø²Ù†Ø¯Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯.";
                }
            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ÛŒØ±.";
            }
        }

        function updateUserOnMap(lat, lng) {
            const userLatLng = L.latLng(lat, lng);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(userLatLng, {
                icon: L.divIcon({
                    className: '',
                    html: '<div style="font-size:36px;">ğŸ“</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map).bindPopup('Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§');

            if (isNavigating) {
                map.setView(userLatLng, 18);
                splitRouteAtNearestPoint(userLatLng); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø³ÛŒØ± Ø·ÛŒâ€ŒØ´Ø¯Ù‡
            } else {
                map.setView(userLatLng, 15);
                fetchRoute([lat, lng], AZADI);
            }
        }

        // Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹
        document.getElementById('start-btn').addEventListener('click', () => {
            if (!navigator.geolocation) {
                document.getElementById('status').innerText = "Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² GPS Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
                return;
            }
            document.getElementById('status').innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...";
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    updateUserOnMap(latitude, longitude);
                    document.getElementById('start-btn').style.display = 'none';
                },
                (err) => {
                    let msg = "Ø®Ø·Ø§ Ø¯Ø± GPS: ";
                    if (err.code === 1) msg += "Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯.";
                    else if (err.code === 2) msg += "Ù…ÙˆÙ‚Ø¹ÛŒØª ÛŒØ§ÙØª Ù†Ø´Ø¯.";
                    else if (err.code === 3) msg += "Ù…Ù‡Ù„Øª ØªÙ…Ø§Ù… Ø´Ø¯.";
                    else msg += "Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡.";
                    document.getElementById('status').innerText = msg;
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        });

        // Ø¯Ú©Ù…Ù‡ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø²Ù†Ø¯Ù‡
        document.getElementById('nav-btn').addEventListener('click', () => {
            isNavigating = true;
            document.getElementById('nav-btn').disabled = true;
            document.getElementById('nav-btn').innerText = "Ù†Ø§ÙˆØ¨Ø±ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª...";
            document.getElementById('status').innerText = "Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø²Ù†Ø¯Ù‡ ÙØ¹Ø§Ù„ Ø´Ø¯.";

            if (navigator.geolocation && userMarker) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        updateUserOnMap(latitude, longitude);
                    },
                    (err) => console.warn("Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ù…Ø¯Ø§ÙˆÙ… Ø®Ø·Ø§ Ø¯Ø§Ø¯:", err),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
                );
            }
        });

        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js').catch(console.error);
            });
        }
    </script>
</body>
</html>
